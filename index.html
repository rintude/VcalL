<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VcalL - Group Video</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --primary: #3b82f6; --danger: #ef4444; }
        .light-mode { --bg: #f1f5f9; --card: #ffffff; --text: #1e293b; --primary: #2563eb; }

        body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; margin: 0; transition: 0.3s; overflow: hidden; }
        .setup-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; gap: 20px; }
        .setup-box { background: var(--card); padding: 40px; border-radius: 24px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); width: 320px; text-align: center; }
        input { width: 100%; padding: 12px; margin: 10px 0; border-radius: 12px; border: 1px solid #334155; background: rgba(0,0,0,0.2); color: inherit; box-sizing: border-box; }
        button { width: 100%; padding: 14px; border: none; border-radius: 12px; cursor: pointer; background: var(--primary); color: white; font-weight: 600; margin-top: 10px; }
        
        #meeting-screen { display: none; padding: 20px; height: 100vh; flex-direction: column; }
        #video-grid { display: grid; gap: 15px; width: 100%; max-width: 1200px; margin: 0 auto; flex-grow: 1; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); align-content: center; }
        .video-container { position: relative; background: #000; border-radius: 16px; overflow: hidden; aspect-ratio: 16/9; }
        video { width: 100%; height: 100%; object-fit: cover; background: #000; }
        .local-video { transform: scaleX(-1); }
        .name-badge { position: absolute; bottom: 12px; left: 12px; background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(4px); color: white; padding: 4px 12px; border-radius: 8px; font-size: 0.85rem; }
        #theme-toggle { position: absolute; top: 20px; right: 20px; width: auto; }
        .leave-btn { background: var(--danger); width: auto; padding: 12px 30px; margin: 20px auto; align-self: center; }
    </style>
</head>
<body>

    <button id="theme-toggle">ðŸŒ“ Mode</button>

    <div id="setup-screen" class="setup-screen">
        <div class="setup-box">
            <h1>VcalL</h1>
            <input type="text" id="username" placeholder="Your Name">
            <input type="text" id="room-code" placeholder="Secret Room Code">
            <button id="join-btn">Join / Create Room</button>
        </div>
    </div>

    <div id="meeting-screen">
        <div id="video-grid"></div>
        <button class="leave-btn" onclick="location.reload()">Leave Room</button>
    </div>

    <script>
        let localStream;
        let myPeer;
        const videoGrid = document.getElementById('video-grid');
        const connectedPeers = {};

        document.getElementById('theme-toggle').onclick = () => document.body.classList.toggle('light-mode');

        document.getElementById('join-btn').onclick = async () => {
            const name = document.getElementById('username').value;
            const roomCode = document.getElementById('room-code').value;

            if (!name || !roomCode) return alert("Enter Name and Code");

            try {
                // FIXED: Request permissions specifically for desktop/mobile compatibility
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                document.getElementById('setup-screen').style.display = 'none';
                document.getElementById('meeting-screen').style.display = 'flex';
                
                addVideo(localStream, name + " (You)", true, 'local');

                // To make a room work without a server, we use roomCode + index (1 to 10)
                // We try to find a free "slot" in the room
                let foundSlot = false;
                for(let i=1; i<=10; i++) {
                    const tryID = `${roomCode}-slot-${i}`;
                    myPeer = new Peer(tryID);
                    
                    myPeer.on('open', id => {
                        foundSlot = true;
                        // Once we are in a slot, we call all other 9 possible slots to see who is there
                        for(let j=1; j<=10; j++) {
                            if(i === j) continue;
                            const targetID = `${roomCode}-slot-${j}`;
                            callUser(targetID);
                        }
                    });

                    myPeer.on('call', call => {
                        call.answer(localStream);
                        call.on('stream', stream => addVideo(stream, "Guest", false, call.peer));
                    });

                    myPeer.on('error', err => {
                        if(err.type === 'unavailable-id') return; // Slot taken, try next
                    });
                    
                    if(foundSlot) break;
                    await new Promise(r => setTimeout(r, 500)); // Short delay to check next slot
                }

            } catch (e) {
                alert("Camera Access Denied. Please ensure you are using HTTPS and have allowed permissions.");
            }
        };

        function callUser(targetID) {
            const call = myPeer.call(targetID, localStream);
            call.on('stream', stream => addVideo(stream, "Guest", false, targetID));
        }

        function addVideo(stream, name, isLocal, peerId) {
            if (document.getElementById(peerId)) return;
            const container = document.createElement('div');
            container.id = peerId;
            container.className = 'video-container';
            const video = document.createElement('video');
            video.srcObject = stream;
            video.autoplay = true;
            video.playsInline = true;
            if (isLocal) video.classList.add('local-video');
            const badge = document.createElement('div');
            badge.className = 'name-badge';
            badge.innerText = name;
            container.append(video, badge);
            videoGrid.append(container);
        }
    </script>
</body>
</html>
